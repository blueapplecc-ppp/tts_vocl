# 系统架构文档

## 整体架构

### 系统概览
TTS火山版采用经典的Web应用架构，基于Flask框架构建，使用MySQL作为数据存储，阿里云OSS作为文件存储，火山引擎TTS作为音频生成服务。

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户浏览器    │    │   Flask应用     │    │   外部服务      │
│                 │    │                 │    │                 │
│  ┌───────────┐  │    │  ┌───────────┐  │    │  ┌───────────┐  │
│  │ 前端界面  │  │◄──►│  │ 路由层    │  │◄──►│  │ 阿里云OSS │  │
│  └───────────┘  │    │  └───────────┘  │    │  └───────────┘  │
│                 │    │  ┌───────────┐  │    │  ┌───────────┐  │
│  ┌───────────┐  │    │  │ 业务逻辑  │  │◄──►│  │ 火山TTS   │  │
│  │ JavaScript│  │    │  └───────────┘  │    │  └───────────┘  │
│  └───────────┘  │    │  ┌───────────┐  │    │                 │
└─────────────────┘    │  │ 数据访问  │  │    └─────────────────┘
                       │  └───────────┘  │
                       │  ┌───────────┐  │    ┌─────────────────┐
                       │  │ 异步任务  │  │    │   数据存储      │
                       │  └───────────┘  │    │                 │
                       └─────────────────┘    │  ┌───────────┐  │
                                              │  │   MySQL   │  │
                                              │  └───────────┘  │
                                              └─────────────────┘
```

## 核心组件

### 1. 前端层
- **技术栈**：HTML5 + Tailwind CSS + JavaScript
- **职责**：用户界面展示、交互处理、文件上传
- **特点**：响应式设计、拖拽上传、实时预览

### 2. 应用层
- **框架**：Flask 3.0.3
- **架构模式**：MVC模式
- **核心模块**：
  - 路由控制器（views.py）
  - 数据模型（models.py）
  - 业务服务（auth.py, oss.py, tts_client.py）
  - 异步任务（tasks.py）

### 3. 数据层
- **数据库**：MySQL 8+
- **ORM**：SQLAlchemy 2.0.32
- **连接池**：支持连接池管理和自动重连
- **事务管理**：支持事务回滚和并发控制

### 4. 存储层
- **文件存储**：阿里云OSS
- **访问模式**：公开读，无需签名
- **文件组织**：按类型和ID分层存储

### 5. 服务层
- **TTS服务**：火山引擎TTS v3
- **异步处理**：ThreadPoolExecutor + BoundedSemaphore
- **任务队列**：有界队列，支持背压控制

## 数据流架构

### 1. 文件上传流程
```
用户操作 → 前端验证 → 表单提交 → 后端处理 → 文件存储 → 数据库记录
    ↓
异步任务 → TTS生成 → 音频存储 → 数据库更新 → 用户通知
```

### 2. 数据查询流程
```
用户请求 → 路由处理 → 业务逻辑 → 数据查询 → 结果封装 → 模板渲染 → 响应返回
```

### 3. 异步任务流程
```
任务提交 → 队列管理 → 任务执行 → 状态更新 → 结果通知
```

## 模块设计

### 1. 应用工厂模式
```python
def create_app() -> Flask:
    """应用工厂函数"""
    app = Flask(__name__)
    
    # 配置加载
    cfg = _load_external_config()
    
    # 数据库初始化
    engine = create_engine(...)
    
    # 服务初始化
    app.config['OSS_CLIENT'] = OssClient(...)
    app.config['TTS_CLIENT'] = VolcTtsClient(...)
    
    # 蓝图注册
    app.register_blueprint(main_bp)
    
    return app
```

### 2. 数据访问层
```python
class TtsText(Base):
    """文本数据模型"""
    __tablename__ = 'tts_texts'
    
    # 字段定义
    id = mapped_column(BigInteger, primary_key=True)
    user_id = mapped_column(BigInteger, ForeignKey('tts_users.id'))
    # ... 其他字段
    
    # 关系定义
    audios = relationship("TtsAudio", back_populates="text")
```

### 3. 服务层抽象
```python
class OssClient:
    """OSS客户端封装"""
    def upload_bytes(self, object_key: str, data: bytes) -> str:
        """上传字节数据"""
        pass
    
    def public_url(self, object_key: str) -> str:
        """生成公开访问URL"""
        pass

class VolcTtsClient:
    """TTS客户端封装"""
    def synthesize(self, text: str, voice: str = "female") -> bytes:
        """文本转语音"""
        pass
```

## 配置管理架构

### 1. 配置层次
```
环境变量 (最高优先级)
    ↓
外部配置文件 (db_config.json)
    ↓
默认配置 (代码中)
```

### 2. 配置加载流程
```python
def _load_external_config() -> dict:
    """加载外部配置"""
    # 1. 读取配置文件
    # 2. 环境变量覆盖
    # 3. 返回最终配置
    pass
```

### 3. 配置验证
- 必需配置项检查
- 配置格式验证
- 服务连通性测试

## 安全架构

### 1. 输入验证
- 文件类型和大小限制
- 文本内容长度检查
- SQL注入防护

### 2. 访问控制
- 鉴权开关机制
- 用户身份验证
- 资源访问权限

### 3. 数据安全
- 敏感信息加密
- 数据库连接安全
- 文件存储安全

## 性能架构

### 1. 并发处理
- 线程池管理
- 连接池复用
- 异步任务队列

### 2. 缓存策略
- 数据库查询缓存
- 静态资源缓存
- 会话状态缓存

### 3. 负载均衡
- 水平扩展支持
- 服务发现机制
- 健康检查

## 监控架构

### 1. 日志系统
```
应用日志 → 文件输出 → 日志轮转 → 日志分析
    ↓
错误日志 → 异常捕获 → 错误报告 → 问题追踪
```

### 2. 性能监控
- 响应时间监控
- 资源使用监控
- 业务指标监控

### 3. 健康检查
- 服务状态检查
- 依赖服务检查
- 数据库连接检查

## 扩展架构

### 1. 水平扩展
- 无状态应用设计
- 负载均衡支持
- 数据库读写分离

### 2. 功能扩展
- 插件化架构
- 微服务拆分
- API版本管理

### 3. 技术升级
- 框架版本升级
- 数据库版本升级
- 第三方服务升级

## 部署架构

### 1. 开发环境
```
开发者机器 → 本地数据库 → 本地服务
```

### 2. 测试环境
```
CI/CD → 测试服务器 → 测试数据库 → 测试服务
```

### 3. 生产环境
```
负载均衡器 → 应用服务器集群 → 数据库集群 → 外部服务
```

## 故障恢复

### 1. 服务降级
- 核心功能优先
- 非核心功能降级
- 用户友好提示

### 2. 数据恢复
- 数据库备份恢复
- 文件存储恢复
- 配置恢复

### 3. 服务重启
- 自动重启机制
- 健康检查恢复
- 服务依赖恢复

---

*最后更新：2025-09-03*
*版本：v1.0.0*
