# å¤±è´¥ä»»åŠ¡é‡è¯•åŠŸèƒ½æ–‡æ¡£

> ä½œè€…ï¼šè˜‘è‡ğŸ„  
> æ—¥æœŸï¼š2025-10-13  
> ç‰ˆæœ¬ï¼šv1.0

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¤±è´¥ä»»åŠ¡é‡è¯•åŠŸèƒ½çš„å®ç°ï¼Œè¯¥åŠŸèƒ½å…è®¸ç”¨æˆ·åœ¨é¦–é¡µç›´æ¥é‡è¯•å¤±è´¥çš„TTSä»»åŠ¡ï¼Œæå‡ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿå¯ç”¨æ€§ã€‚

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1ï¸âƒ£ **çœŸå®ä»»åŠ¡çŠ¶æ€æ˜¾ç¤º**
- âœ… **å¤„ç†ä¸­**ï¼šæ˜¾ç¤º"â³ å¤„ç†ä¸­..."å’Œ"æŸ¥çœ‹è¿›åº¦"é“¾æ¥
- âœ… **å¤±è´¥/è¶…æ—¶**ï¼šæ˜¾ç¤º"âŒ ä»»åŠ¡å¤±è´¥"å’Œ"ğŸ”„ é‡è¯•"æŒ‰é’®
- âœ… **æœªç”Ÿæˆ**ï¼šæ˜¾ç¤º"æœªç”ŸæˆéŸ³é¢‘"å’Œ"ç”ŸæˆéŸ³é¢‘"æŒ‰é’®
- âœ… **å·²å®Œæˆ**ï¼šæ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨å’Œä¸‹è½½é“¾æ¥

### 2ï¸âƒ£ **ä¸€é”®é‡è¯•**
- âœ… ç‚¹å‡»é‡è¯•æŒ‰é’®ç«‹å³æäº¤ä»»åŠ¡
- âœ… å®æ—¶æ˜¾ç¤ºä»»åŠ¡è¿›åº¦ï¼ˆSSEæ¨é€ï¼‰
- âœ… ä»»åŠ¡å®Œæˆåè‡ªåŠ¨åˆ·æ–°æ˜¾ç¤ºéŸ³é¢‘
- âœ… å¤±è´¥åå¯å†æ¬¡é‡è¯•

### 3ï¸âƒ£ **æ•°æ®ä¸€è‡´æ€§ä¿æŠ¤**
- âœ… æ•°æ®åº“å”¯ä¸€çº¦æŸé˜²æ­¢é‡å¤è®°å½•
- âœ… å¤šå±‚æ£€æŸ¥é˜²æ­¢å¹¶å‘å†²çª
- âœ… å¹‚ç­‰æ€§ä¿è¯ä»»åŠ¡å®‰å…¨

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. æ•°æ®åº“ä¿®æ”¹

#### æ·»åŠ å”¯ä¸€çº¦æŸ
```sql
-- ç¡®ä¿åŒä¸€ text_id åœ¨æœªåˆ é™¤çŠ¶æ€ä¸‹åªæœ‰ä¸€æ¡éŸ³é¢‘è®°å½•
ALTER TABLE tts_audios 
ADD CONSTRAINT uq_tts_audios_text_id_active 
UNIQUE (text_id, is_deleted);
```

**é‡è¦æç¤º**ï¼š
- âš ï¸ æ‰§è¡Œå‰éœ€æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤è®°å½•
- âš ï¸ è¿ç§»è„šæœ¬ä½äº `migrations/add_text_id_unique_constraint.sql`
- âš ï¸ éœ€è¦åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œæ­¤è¿ç§»

#### æ£€æŸ¥é‡å¤è®°å½•
```sql
SELECT text_id, COUNT(*) as count
FROM tts_audios
WHERE is_deleted = 0
GROUP BY text_id
HAVING count > 1;
```

#### æ¸…ç†é‡å¤è®°å½•ï¼ˆå¦‚æœæœ‰ï¼‰
```sql
-- ä¿ç•™æœ€æ–°çš„è®°å½•ï¼Œåˆ é™¤æ—§è®°å½•
DELETE a1 FROM tts_audios a1
INNER JOIN tts_audios a2 
WHERE a1.text_id = a2.text_id 
  AND a1.is_deleted = 0 
  AND a2.is_deleted = 0
  AND a1.id < a2.id;
```

---

### 2. åç«¯å®ç°

#### ä¿®æ”¹æ–‡ä»¶ï¼š`app/models.py`
```python
class TtsAudio(Base):
    __table_args__ = (
        UniqueConstraint('oss_object_key', name='uq_tts_audios_oss_object_key'),
        UniqueConstraint('text_id', 'is_deleted', name='uq_tts_audios_text_id_active'),  # æ–°å¢
    )
```

#### ä¿®æ”¹æ–‡ä»¶ï¼š`app/views.py`

**1. é¦–é¡µä¼ é€’ä»»åŠ¡çŠ¶æ€**
```python
@bp.get('/')
def index():
    # ... åŸæœ‰ä»£ç  ...
    
    # è·å–ä»»åŠ¡çŠ¶æ€
    monitor = current_app.config['MONITOR']
    task_status_map = {}
    for text in items:
        status = monitor.get_task_status(text.id)
        if status:
            task_status_map[text.id] = status
    
    return render_template('text_library.html', 
                         task_status_map=task_status_map,  # æ–°å¢
                         ...)
```

**2. æ–°å¢é‡è¯•API**
```python
@bp.post('/api/task/retry/<int:text_id>')
def retry_task(text_id: int):
    """é‡è¯•å¤±è´¥çš„TTSä»»åŠ¡"""
    # 1. æ£€æŸ¥æ˜¯å¦å·²æœ‰è¿›è¡Œä¸­çš„ä»»åŠ¡
    # 2. æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å·²æœ‰éŸ³é¢‘
    # 3. æäº¤åå°ä»»åŠ¡
```

**å¤šå±‚é˜²æŠ¤æœºåˆ¶**ï¼š
- âœ… æ£€æŸ¥TaskMonitoræ˜¯å¦æœ‰è¿›è¡Œä¸­ä»»åŠ¡
- âœ… æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å·²æœ‰éŸ³é¢‘è®°å½•
- âœ… å¹‚ç­‰æ€§ä¿è¯ï¼ˆTaskServiceå±‚ï¼‰

---

### 3. å‰ç«¯å®ç°

#### ä¿®æ”¹æ–‡ä»¶ï¼š`templates/text_library.html`

**1. çŠ¶æ€æ˜¾ç¤ºé€»è¾‘**
```html
{% if audios_map.get(it.id, []) %}
    <!-- æœ‰éŸ³é¢‘ï¼šæ˜¾ç¤ºæ’­æ”¾å™¨ -->
{% elif task_status_map.get(it.id) %}
    {% if task.status == 'processing' %}
        <!-- å¤„ç†ä¸­ï¼šæ˜¾ç¤ºè¿›åº¦ -->
    {% elif task.status == 'failed' or task.status == 'timeout' %}
        <!-- å¤±è´¥ï¼šæ˜¾ç¤ºé‡è¯•æŒ‰é’® -->
    {% endif %}
{% else %}
    <!-- æœªå¼€å§‹ï¼šæ˜¾ç¤ºç”ŸæˆæŒ‰é’® -->
{% endif %}
```

**2. é‡è¯•é€»è¾‘**
```javascript
async function retryTask(textId) {
    // 1. ç¦ç”¨æŒ‰é’®
    // 2. å‘é€é‡è¯•è¯·æ±‚
    // 3. æ˜¾ç¤ºå¤„ç†ä¸­çŠ¶æ€
    // 4. å¯åŠ¨SSEç›‘æ§
}
```

**3. SSEç›‘æ§**
```javascript
function startTaskMonitoring(textId, container) {
    const eventSource = new EventSource(`/api/task/stream/${textId}`);
    
    eventSource.onmessage = function(event) {
        if (data.status === 'completed') {
            location.reload();  // åˆ·æ–°æ˜¾ç¤ºéŸ³é¢‘
        } else if (data.status === 'failed') {
            // æ˜¾ç¤ºå¤±è´¥å’Œé‡è¯•æŒ‰é’®
        }
    };
}
```

---

## ğŸ“Š ç”¨æˆ·äº¤äº’æµç¨‹

```
ç”¨æˆ·åœ¨é¦–é¡µçœ‹åˆ°ä»»åŠ¡çŠ¶æ€
    â†“
[æƒ…å†µ1] æœ‰éŸ³é¢‘ â†’ æ˜¾ç¤ºæ’­æ”¾å™¨
[æƒ…å†µ2] å¤„ç†ä¸­ â†’ æ˜¾ç¤º"â³ å¤„ç†ä¸­..."
[æƒ…å†µ3] å¤±è´¥ â†’ æ˜¾ç¤º"âŒ ä»»åŠ¡å¤±è´¥" + "ğŸ”„ é‡è¯•"
[æƒ…å†µ4] æœªç”Ÿæˆ â†’ æ˜¾ç¤º"æœªç”ŸæˆéŸ³é¢‘" + "ç”ŸæˆéŸ³é¢‘"
    â†“
ç”¨æˆ·ç‚¹å‡»"ğŸ”„ é‡è¯•"æˆ–"ç”ŸæˆéŸ³é¢‘"
    â†“
å‰ç«¯ï¼š
  - ç¦ç”¨æŒ‰é’®
  - å‘é€POST /api/task/retry/{text_id}
    â†“
åç«¯æ£€æŸ¥ï¼š
  - ä»»åŠ¡æ˜¯å¦è¿›è¡Œä¸­ï¼Ÿâ†’ è¿”å›409
  - éŸ³é¢‘æ˜¯å¦å·²å­˜åœ¨ï¼Ÿâ†’ è¿”å›200
  - éƒ½æ²¡æœ‰ï¼Ÿâ†’ æäº¤ä»»åŠ¡
    â†“
å‰ç«¯ï¼š
  - æ˜¾ç¤º"â³ å¤„ç†ä¸­..."
  - å¯åŠ¨SSEç›‘æ§
    â†“
SSEå®æ—¶æ¨é€çŠ¶æ€ï¼š
  - processing â†’ ç»§ç»­ç­‰å¾…
  - completed â†’ åˆ·æ–°é¡µé¢æ˜¾ç¤ºéŸ³é¢‘
  - failed â†’ æ˜¾ç¤ºå¤±è´¥å’Œé‡è¯•æŒ‰é’®
```

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. æ•°æ®åº“è¿ç§» ğŸš¨
**å¿…é¡»åœ¨é‡å¯æœåŠ¡å‰æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼**

```bash
# 1. å¤‡ä»½æ•°æ®åº“
mysqldump -u user -p database_name > backup_$(date +%Y%m%d).sql

# 2. æ£€æŸ¥é‡å¤è®°å½•
mysql -u user -p database_name < migrations/add_text_id_unique_constraint.sql

# 3. å¦‚æœ‰é‡å¤ï¼Œå…ˆæ¸…ç†
# å‚è€ƒè¿ç§»è„šæœ¬ä¸­çš„æ¸…ç†SQL

# 4. æ‰§è¡Œè¿ç§»
ALTER TABLE tts_audios ADD CONSTRAINT uq_tts_audios_text_id_active UNIQUE (text_id, is_deleted);
```

### 2. å…¼å®¹æ€§
- âœ… å‘åå…¼å®¹ï¼šä¸å½±å“ç°æœ‰åŠŸèƒ½
- âœ… ä¼˜é›…é™çº§ï¼šå³ä½¿SSEå¤±è´¥ä¹Ÿèƒ½æ‰‹åŠ¨åˆ·æ–°
- âœ… é˜²æŠ¤å®Œå–„ï¼šå¤šå±‚æ£€æŸ¥é˜²æ­¢æ•°æ®ä¸ä¸€è‡´

### 3. æ€§èƒ½è€ƒè™‘
- âœ… TaskMonitorå†…å­˜æŸ¥è¯¢ï¼šæ¯«ç§’çº§å“åº”
- âœ… æ•°æ®åº“ç´¢å¼•ï¼štext_idå·²æœ‰å¤–é”®ç´¢å¼•
- âœ… SSEè¿æ¥ï¼š30ç§’è‡ªåŠ¨å…³é—­ï¼Œé˜²æ­¢å ç”¨

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šæ­£å¸¸é‡è¯•
```
1. æ‰¾åˆ°å¤±è´¥ä»»åŠ¡
2. ç‚¹å‡»"ğŸ”„ é‡è¯•"
3. ç­‰å¾…ä»»åŠ¡å®Œæˆ
4. é¡µé¢è‡ªåŠ¨åˆ·æ–°æ˜¾ç¤ºéŸ³é¢‘
```

### åœºæ™¯2ï¼šé‡å¤ç‚¹å‡»é˜²æŠ¤
```
1. ç‚¹å‡»"ğŸ”„ é‡è¯•"
2. æŒ‰é’®ç¦ç”¨å˜ä¸º"é‡è¯•ä¸­..."
3. å†æ¬¡ç‚¹å‡»æ— æ•ˆ
4. ä»»åŠ¡å®Œæˆåæ¢å¤
```

### åœºæ™¯3ï¼šä»»åŠ¡å·²åœ¨è¿›è¡Œä¸­
```
1. ä»»åŠ¡æ­£åœ¨å¤„ç†ä¸­
2. ç‚¹å‡»"ğŸ”„ é‡è¯•"
3. è¿”å›409ï¼Œæ˜¾ç¤º"å¤„ç†ä¸­"
4. è‡ªåŠ¨å¯åŠ¨SSEç›‘æ§
```

### åœºæ™¯4ï¼šéŸ³é¢‘å·²å­˜åœ¨
```
1. éŸ³é¢‘å·²ç”Ÿæˆä½†é¡µé¢æœªåˆ·æ–°
2. ç‚¹å‡»"ğŸ”„ é‡è¯•"
3. è¿”å›"éŸ³é¢‘å·²å­˜åœ¨"
4. è‡ªåŠ¨åˆ·æ–°é¡µé¢æ˜¾ç¤ºéŸ³é¢‘
```

### åœºæ™¯5ï¼šå¹¶å‘é‡è¯•
```
1. å¤šä¸ªç”¨æˆ·åŒæ—¶é‡è¯•åŒä¸€ä»»åŠ¡
2. åªæœ‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œ
3. å…¶ä»–è¯·æ±‚è¿”å›"ä»»åŠ¡è¿›è¡Œä¸­"æˆ–"éŸ³é¢‘å·²å­˜åœ¨"
4. æ•°æ®ä¸€è‡´æ€§å¾—åˆ°ä¿è¯
```

---

## ğŸ“ ä»£ç å˜æ›´ç»Ÿè®¡

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | è¡Œæ•° |
|------|---------|------|
| `app/models.py` | æ–°å¢çº¦æŸ | 1 |
| `app/views.py` | æ–°å¢åŠŸèƒ½ | 74 |
| `templates/text_library.html` | æ–°å¢UIå’Œé€»è¾‘ | 140 |
| `migrations/add_text_id_unique_constraint.sql` | æ–°å¢ | 30 |
| **æ€»è®¡** | - | **245** |

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šé‡è¯•æŒ‰é’®ç‚¹å‡»æ— ååº”
**æ’æŸ¥**ï¼š
```javascript
// æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹
console.log('é‡è¯•è¯·æ±‚:', textId);
// æ£€æŸ¥ç½‘ç»œè¯·æ±‚
```

**è§£å†³**ï¼š
- æ£€æŸ¥æŒ‰é’®IDæ˜¯å¦æ­£ç¡®
- æ£€æŸ¥JavaScriptæ˜¯å¦åŠ è½½
- æ£€æŸ¥ç½‘ç»œè¯·æ±‚æ˜¯å¦æˆåŠŸ

### é—®é¢˜2ï¼šä»»åŠ¡æäº¤åæ— è¿›åº¦æ˜¾ç¤º
**æ’æŸ¥**ï¼š
```bash
# æ£€æŸ¥SSEç«¯ç‚¹
curl http://localhost:8082/api/task/stream/123
```

**è§£å†³**ï¼š
- æ£€æŸ¥TaskMonitoræ˜¯å¦æ­£å¸¸
- æ£€æŸ¥SSEè¿æ¥æ˜¯å¦å»ºç«‹
- æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯

### é—®é¢˜3ï¼šæ•°æ®åº“çº¦æŸå†²çª
**ç°è±¡**ï¼š
```
IntegrityError: Duplicate entry for key 'uq_tts_audios_text_id_active'
```

**æ’æŸ¥**ï¼š
```sql
SELECT * FROM tts_audios 
WHERE text_id = 123 AND is_deleted = 0;
```

**è§£å†³**ï¼š
- æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤è®°å½•
- åˆ é™¤æ—§è®°å½•æˆ–æ ‡è®°ä¸ºå·²åˆ é™¤

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¹¶å‘ä¼˜åŒ–æ–‡æ¡£](./CONCURRENT_OPTIMIZATION.md)
- [APIå‚è€ƒæ–‡æ¡£](./API_REFERENCE.md)
- [å¼€å‘æŒ‡å—](./DEVELOPMENT_GUIDE.md)

---

**ä½œè€…ï¼šè˜‘è‡ğŸ„**  
**æœ€åæ›´æ–°ï¼š2025-10-13**

